@using Mud.Client.Services

<div class="character-sheet-overlay @(IsOpen ? "open" : "")" @onclick="OnOverlayClick">
    <div class="character-sheet" @onclick:stopPropagation>
        <h2>@PlayerName</h2>

        <div class="level-section">
            <span class="level">Level @Level</span>
            <div class="xp-bar">
                <div class="xp-fill" style="width: @XpPercentage%"></div>
            </div>
            <span class="xp-text">@Experience / @ExperienceToNext XP</span>
        </div>

        <div class="attributes">
            <div class="attribute">
                <span class="attr-name">Strength</span>
                <span class="attr-value">@Strength</span>
                @if (UnspentPoints > 0)
                {
                    <button class="add-btn" @onclick="@(() => AllocateStatAsync("strength"))">+</button>
                }
            </div>
            <div class="attribute">
                <span class="attr-name">Dexterity</span>
                <span class="attr-value">@Dexterity</span>
                @if (UnspentPoints > 0)
                {
                    <button class="add-btn" @onclick="@(() => AllocateStatAsync("dexterity"))">+</button>
                }
            </div>
            <div class="attribute">
                <span class="attr-name">Stamina</span>
                <span class="attr-value">@Stamina</span>
                @if (UnspentPoints > 0)
                {
                    <button class="add-btn" @onclick="@(() => AllocateStatAsync("stamina"))">+</button>
                }
            </div>
        </div>

        @if (UnspentPoints > 0)
        {
            <div class="unspent">@UnspentPoints unspent points</div>
        }

        <div class="derived-stats">
            <div>Melee Damage: @(5 + Strength)</div>
            <div>Ranged Damage: @(5 + Dexterity)</div>
            <div>Max Health: @(50 + Stamina * 10)</div>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<string> OnAllocateStat { get; set; }

    [Parameter] public string PlayerName { get; set; } = "";
    [Parameter] public int Level { get; set; } = 1;
    [Parameter] public int Experience { get; set; }
    [Parameter] public int Strength { get; set; } = 5;
    [Parameter] public int Dexterity { get; set; } = 5;
    [Parameter] public int Stamina { get; set; } = 5;
    [Parameter] public int UnspentPoints { get; set; }

    // XP required to reach next level (cumulative threshold)
    private int ExperienceToNext => Level >= 60 ? Experience : 100 * Level * Level;
    // XP at start of current level
    private int PreviousLevelXp => Level > 1 ? 100 * (Level - 1) * (Level - 1) : 0;
    // Progress percentage within current level
    private double XpPercentage => Level >= 60 ? 100 :
        ExperienceToNext > PreviousLevelXp
            ? (double)(Experience - PreviousLevelXp) / (ExperienceToNext - PreviousLevelXp) * 100
            : 0;

    private async Task AllocateStatAsync(string stat)
    {
        await OnAllocateStat.InvokeAsync(stat);
    }

    private async Task OnOverlayClick()
    {
        await OnClose.InvokeAsync();
    }
}
